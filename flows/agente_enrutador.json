{
    "name": "DEV_GC_Agente_Enrutador_Odoo18_Handover_Final",
    "nodes": [
        {
            "parameters": {
                "httpMethod": "POST",
                "path": "odoo-livechat-webhook",
                "options": {}
            },
            "id": "webhook-trigger",
            "name": "Odoo LiveChat Webhook",
            "type": "n8n-nodes-base.webhook",
            "typeVersion": 1,
            "position": [
                0,
                300
            ]
        },
        {
            "parameters": {
                "conditions": {
                    "string": [
                        {
                            "value1": "={{$json.active_specialist}}",
                            "operation": "isNotEmpty"
                        }
                    ]
                }
            },
            "id": "check-specialist",
            "name": "Tiene Especialista?",
            "type": "n8n-nodes-base.if",
            "typeVersion": 1,
            "position": [
                200,
                300
            ]
        },
        {
            "parameters": {
                "options": {
                    "systemMessage": "Eres un clasificador de intenciones experto. Analiza el mensaje del cliente y clasifícalo en: 'web', 'apps', 'marketing'. Responde solo JSON: {\"intencion\": \"categoría\"}"
                }
            },
            "id": "ai-intent-detector",
            "name": "Detección de Intención IA",
            "type": "@n8n/n8n-nodes-langchain.chainLlm",
            "typeVersion": 1.4,
            "position": [
                400,
                150
            ]
        },
        {
            "parameters": {
                "method": "POST",
                "url": "https://dev.erpelantar.com/n8n_bridge/update_state",
                "sendBody": true,
                "specifyBody": "json",
                "jsonBody": "={\n  \"params\": {\n    \"channel_id\": {{$node[\"Odoo LiveChat Webhook\"].json[\"res_id\"]}},\n    \"specialist_id\": \"{{$json[\"intencion\"]}}\"\n  }\n}",
                "options": {}
            },
            "id": "update-odoo-state",
            "name": "Actualizar Estado Odoo",
            "type": "n8n-nodes-base.httpRequest",
            "typeVersion": 4.1,
            "position": [
                600,
                150
            ]
        },
        {
            "parameters": {
                "values": {
                    "string": [
                        {
                            "name": "body",
                            "value": "={{$node[\"Odoo LiveChat Webhook\"].json[\"body\"]}}"
                        },
                        {
                            "name": "res_id",
                            "value": "={{$node[\"Odoo LiveChat Webhook\"].json[\"res_id\"]}}"
                        },
                        {
                            "name": "active_specialist",
                            "value": "={{$json[\"active_specialist\"] || $node[\"Actualizar Estado Odoo\"].json[\"result\"][\"active_specialist\"]}}"
                        },
                        {
                            "name": "context_data",
                            "value": "={{$node[\"Odoo LiveChat Webhook\"].json[\"context_data\"]}}"
                        }
                    ]
                },
                "options": {}
            },
            "id": "prepare-payload",
            "name": "Preparar Datos Especialista",
            "type": "n8n-nodes-base.set",
            "typeVersion": 3.2,
            "position": [
                800,
                300
            ]
        },
        {
            "parameters": {
                "dataType": "string",
                "value1": "={{$json.active_specialist}}",
                "rules": {
                    "rules": [
                        {
                            "value2": "web"
                        },
                        {
                            "value2": "apps",
                            "outputIndex": 1
                        },
                        {
                            "value2": "marketing",
                            "outputIndex": 2
                        }
                    ]
                }
            },
            "id": "specialist-router",
            "name": "Router de Especialistas",
            "type": "n8n-nodes-base.switch",
            "typeVersion": 1,
            "position": [
                1000,
                300
            ]
        },
        {
            "parameters": {
                "workflowId": "mdc7PbFwxXZKimSj",
                "options": {}
            },
            "id": "call-web",
            "name": "Llamar Especialista Web",
            "type": "n8n-nodes-base.executeWorkflow",
            "typeVersion": 1,
            "position": [
                1250,
                150
            ]
        },
        {
            "parameters": {
                "workflowId": "k5tE2GtY0EWqkaDe",
                "options": {}
            },
            "id": "call-apps",
            "name": "Llamar Especialista Apps",
            "type": "n8n-nodes-base.executeWorkflow",
            "typeVersion": 1,
            "position": [
                1250,
                300
            ]
        },
        {
            "parameters": {
                "workflowId": "ksIb4ZaQRE1fgbfB",
                "options": {}
            },
            "id": "call-marketing",
            "name": "Llamar Especialista Marketing",
            "type": "n8n-nodes-base.executeWorkflow",
            "typeVersion": 1,
            "position": [
                1250,
                450
            ]
        },
        {
            "parameters": {
                "model": "llama3-70b-8192",
                "options": {}
            },
            "id": "groq-lm",
            "name": "Groq Chat Model",
            "type": "@n8n/n8n-nodes-langchain.lmChatGroq",
            "typeVersion": 1,
            "position": [
                400,
                0
            ],
            "credentials": {
                "groqApi": {
                    "id": "nfpxWh3Y5sUHefoj"
                }
            }
        }
    ],
    "connections": {
        "Odoo LiveChat Webhook": {
            "main": [
                [
                    {
                        "node": "Tiene Especialista?",
                        "type": "main",
                        "index": 0
                    }
                ]
            ]
        },
        "Tiene Especialista?": {
            "main": [
                [
                    {
                        "node": "Detección de Intención IA",
                        "type": "main",
                        "index": 0
                    }
                ],
                [
                    {
                        "node": "prepare-payload",
                        "type": "main",
                        "index": 0
                    }
                ]
            ]
        },
        "Detección de Intención IA": {
            "main": [
                [
                    {
                        "node": "update-odoo-state",
                        "type": "main",
                        "index": 0
                    }
                ]
            ]
        },
        "update-odoo-state": {
            "main": [
                [
                    {
                        "node": "prepare-payload",
                        "type": "main",
                        "index": 0
                    }
                ]
            ]
        },
        "prepare-payload": {
            "main": [
                [
                    {
                        "node": "specialist-router",
                        "type": "main",
                        "index": 0
                    }
                ]
            ]
        },
        "specialist-router": {
            "main": [
                [
                    {
                        "node": "Llamar Especialista Web",
                        "type": "main",
                        "index": 0
                    }
                ],
                [
                    {
                        "node": "Llamar Especialista Apps",
                        "type": "main",
                        "index": 0
                    }
                ],
                [
                    {
                        "node": "Llamar Especialista Marketing",
                        "type": "main",
                        "index": 0
                    }
                ]
            ]
        },
        "Groq Chat Model": {
            "ai_languageModel": [
                [
                    {
                        "node": "Detección de Intención IA",
                        "type": "ai_languageModel",
                        "index": 0
                    }
                ]
            ]
        }
    }
}